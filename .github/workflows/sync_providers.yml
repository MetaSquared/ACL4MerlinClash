name: Sync Providers from ACL4SSR

on:
  schedule:
    - cron: '0 */3 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout Target Repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Clone Source Repository (Single Branch)
        run: |
          # 建立临时文件夹并进入
          mkdir -p temp_source
          cd temp_source
          git init
          git remote add origin https://github.com/ACL4SSR/ACL4SSR.git
          # 开启稀疏检出
          git config core.sparseCheckout true
          # 设置要同步的具体路径
          echo "Clash/Providers/" >> .git/info/sparse-checkout
          # 仅拉取 master 分支
          git pull --depth 1 origin master
          cd ..

      - name: Sync Files
        run: |
          # 确保目标目录存在
          # 如果你想放在根目录就用 ./，如果想放在特定文件夹就改这里
          TARGET_DIR="./"
          
          # 使用 -R (递归) 和 -u (仅更新较新的文件) 
          # 这样比 -n 更稳健，且能处理 Ruleset 文件夹
          cp -Ru temp_source/Clash/Providers/* "$TARGET_DIR"
          
          # 清理临时文件
          rm -rf temp_source

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add .
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes detected. Skipping commit."
          else
            git commit -m "chore: sync files from ACL4SSR/Clash/Providers ($(date +'%Y-%m-%d %H:%M'))"
            git push origin main
          fi
